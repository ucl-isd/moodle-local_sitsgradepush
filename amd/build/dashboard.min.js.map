{"version":3,"file":"dashboard.min.js","sources":["../src/dashboard.js"],"sourcesContent":["import {schedulePushTask, getAssessmentsUpdate, updateProgressBar} from \"./sitsgradepush_helper\";\nimport notification from \"core/notification\";\n\nlet updatePageIntervalId = null; // The interval ID for updating the progress.\nlet globalCourseid = null; // The global variable for course ID.\nlet updatePageDelay = 15000; // The delay for updating the page.\n\n/**\n * Initialize the dashboard page.\n *\n * @param {int} courseid\n */\nexport const init = (courseid) => {\n    // If there is a saved message by successfully mapped an assessment in localStorage, display it.\n    displayNotification();\n\n    // Set the global variable course ID.\n    globalCourseid = courseid;\n\n    // Initialize the module delivery dropdown list.\n    initModuleDeliverySelector(window);\n\n    // Initialize assessment updates.\n    initAssessmentUpdate(courseid);\n\n    // Initialize confirmation modal.\n    initConfirmationModal(window);\n};\n\n/**\n * Initialize the module delivery dropdown list.\n *\n * @param {Window} page\n */\nfunction initModuleDeliverySelector(page) {\n    // Find all the dropdown items.\n    let dropdownitems = document.querySelectorAll('.jump-to-dropdown-item');\n\n    // Add event listener to each dropdown item.\n    dropdownitems.forEach(function(item) {\n        item.addEventListener('click', function() {\n            let value = item.getAttribute('data-value');\n            if (value !== null) {\n                // Get the scroll position of the page.\n                let pagePosition = getPagePosition(page);\n\n                // Find the selected table by ID.\n                let selectedTable = document.getElementById(value);\n\n                // Calculate the scroll position to be 100 pixels above the table.\n                if (selectedTable) {\n                    let offset = -100;\n                    let tablePosition = selectedTable.getBoundingClientRect().top;\n                    let scrollPosition = pagePosition + tablePosition + offset;\n\n                    // Scroll to the calculated position.\n                    page.scrollTo({\n                        top: scrollPosition,\n                        behavior: \"smooth\"\n                    });\n                }\n            }\n        });\n    });\n}\n\n/**\n * Initialize the confirmation modal.\n *\n * @param {Window} page\n */\nfunction initConfirmationModal(page) {\n    // Find the confirmation modal.\n    let confirmTransferButton = document.getElementById(\"js-transfer-modal-button\");\n\n    // Exit if the confirmation modal is not found.\n    if (confirmTransferButton === null) {\n        return;\n    }\n\n    // Add event listener to the confirmation modal.\n    confirmTransferButton.addEventListener(\"click\", async function() {\n        let assessmentmappingid = confirmTransferButton.getAttribute('data-assessmentmappingid');\n        if (assessmentmappingid !== null && assessmentmappingid !== 'all') {\n            // Single transfer.\n            await pushMarks(assessmentmappingid);\n        } else if (assessmentmappingid === 'all') {\n            // Bulk transfer.\n            await pushAllMarks(page);\n        }\n    });\n}\n\n/**\n * Initialize the assessment updates.\n *\n * @param {int} courseid\n */\nfunction initAssessmentUpdate(courseid) {\n    updateAssessments(courseid);\n\n    // Update the page every 15 seconds.\n    updatePageIntervalId = setInterval(() => {\n        updateAssessments(courseid);\n    }, updatePageDelay);\n\n    // Add event listener to stop update the page when the page is not visible. e.g. when the user switches to another tab.\n    document.addEventListener(\"visibilitychange\", function() {\n        if (document.visibilityState === \"hidden\") {\n            clearInterval(updatePageIntervalId);\n        } else {\n            updateAssessments(courseid);\n            updatePageIntervalId = setInterval(() => {\n                updateAssessments(courseid);\n            }, updatePageDelay);\n        }\n    });\n}\n\n/**\n * Schedule a push task when the user clicks on a push button.\n *\n * @param {int} assessmentmappingid The button element.\n * @return {Promise|boolean} Promise.\n */\nasync function pushMarks(assessmentmappingid) {\n    try {\n        // Schedule a push task.\n        let result = await schedulePushTask(assessmentmappingid);\n\n        // Check if the push task is successfully scheduled.\n        if (result.success) {\n            updateAssessments(globalCourseid);\n        }\n        let message = '';\n        if (!result.success && result.message) {\n            message = result.message;\n        }\n\n        // Show error message if there is any.\n        showTransferErrorMessage(assessmentmappingid, message);\n        return result;\n    } catch (error) {\n        window.console.error(error);\n        return false;\n    }\n}\n\n/**\n *\n * @param {HTMLElement} page\n * @return {Promise<void>}\n */\nasync function pushAllMarks(page) {\n    let assessmentmappings = Array.from(document.querySelectorAll('.marks-col-field'))\n        .filter(element =>\n            parseInt(element.getAttribute('data-markscount'), 10) > 0 &&\n            element.getAttribute('data-task-running') === 'false'\n        );\n\n    // Number of not disabled push buttons.\n    let total = assessmentmappings.length;\n    let count = 0;\n\n    // Create an array to hold all the Promises.\n    let promises = [];\n\n    // Push grades to SITS for each component grade.\n    assessmentmappings.forEach(function(element) {\n        // Get the assessment mapping ID.\n        let assessmentmappingid = element.getAttribute('data-assessmentmappingid');\n        // Create a Promise for each button and push it into the array.\n        let promise = pushMarks(assessmentmappingid)\n            .then(function(result) {\n                if (result.success) {\n                    count = count + 1;\n                }\n                return result;\n            }).catch(function(error) {\n                window.console.error(error);\n            });\n\n        promises.push(promise);\n    });\n\n    // Wait for all Promises to resolve.\n    await Promise.all(promises);\n\n    // Scroll to the top of the page so that the user can see the notification.\n    page.scrollTo({top: 0, behavior: \"instant\"});\n\n    // Show the notification.\n    await notification.addNotification({\n        message: count + ' of ' + total + ' push tasks have been scheduled.',\n        type: (count === total) ? 'success' : 'warning'\n    });\n\n    // Update the page information.\n    updateAssessments(globalCourseid);\n}\n\n/**\n * Update the dashboard page with the latest information.\n * e.g. progress bars, push buttons, records icons.\n *\n * @param {int} courseid\n * @return {Promise<void>}\n */\nasync function updateAssessments(courseid) {\n    // Get latest assessments information for the dashboard page.\n    let update = await getAssessmentsUpdate(courseid);\n\n    if (update.success) {\n        // Parse the JSON string.\n        let assessments = JSON.parse(update.assessments);\n\n        if (assessments.length > 0) {\n            updateMarksColumn(assessments);\n        }\n    } else {\n        // Stop update the page if error occurred.\n        clearInterval(updatePageIntervalId);\n        window.console.error(update.message);\n    }\n}\n\n/**\n * Update the marks' column for all assessments mappings.\n *\n * @param {object[]} assessments\n */\nfunction updateMarksColumn(assessments) {\n    // Update assessment components which has mappings.\n    assessments.forEach(assessment => {\n        let marksColumnFieldId = 'marks-col-field-' + assessment.assessmentmappingid;\n        let marksColumnField = document.getElementById(marksColumnFieldId);\n        if (marksColumnField) {\n            let marksContainer = marksColumnField.querySelector('.marks-container');\n            let taskContainer = marksColumnField.querySelector('.task-status-container');\n\n            // Set the marks count attribute.\n            marksColumnField.setAttribute('data-markscount', assessment.markscount);\n\n            // Marks count element that displays the number of marks.\n            let marksCountElement = marksColumnField.querySelector('.marks-count');\n\n            // Update the marks count.\n            marksCountElement.innerHTML = assessment.markscount;\n\n            // Show the transfer button if there are marks to transfer.\n            let transferButton = marksColumnField.querySelector('.js-btn-transfer-marks');\n            if (assessment.markscount > 0) {\n                transferButton.style.display = 'block';\n            } else {\n                transferButton.style.display = 'none';\n            }\n\n            // Show marks information if no task running.\n            if (assessment.task === null) {\n                marksColumnField.setAttribute('data-task-running', false);\n                taskContainer.style.display = 'none';\n                marksContainer.style.display = 'block';\n            } else {\n                // Show task information if task running.\n                marksColumnField.setAttribute('data-task-running', true);\n                marksContainer.style.display = 'none';\n                taskContainer.style.display = 'block';\n                updateProgressBar(taskContainer, assessment.task.progress);\n            }\n        }\n    });\n}\n\n/**\n * Show an error message at the table row under the button.\n *\n * @param {int} assessmentmappingid\n * @param {string} message\n */\nfunction showTransferErrorMessage(assessmentmappingid, message) {\n    // Find the marks column field.\n    let marksColumnField = document.getElementById('marks-col-field-' + assessmentmappingid);\n\n    // Find the closest row to the button.\n    let currentrow = marksColumnField.closest(\"tr\");\n\n    // Remove the existing error message row if it exists.\n    if (currentrow.nextElementSibling !== null &&\n        currentrow.nextElementSibling.classList.contains(\"error-message-row\")) {\n        currentrow.nextElementSibling.remove();\n    }\n\n    if (message !== '') {\n        // Create an error message row.\n        let errormessagerow = document.createElement(\"tr\");\n\n        // Set the class and content of the error message row.\n        errormessagerow.setAttribute(\"class\", \"error-message-row\");\n        errormessagerow.innerHTML =\n            '<td colspan=\"4>\">' +\n            '<div class=\"alert alert-danger\" role=\"alert\">' + message + '</div>' +\n            '</td>';\n\n        // Insert the error message row after the current row.\n        currentrow.insertAdjacentElement(\"afterend\", errormessagerow);\n    }\n}\n\n/**\n * Display a notification if a success message is available in localStorage.\n */\nfunction displayNotification() {\n    // Retrieve the success message from localStorage.\n    let successMessage = localStorage.getItem('successMessage');\n\n    // Check if a success message is available.\n    if (successMessage) {\n        // Display the success message using a notification library or other means.\n        notification.addNotification({\n            message: successMessage,\n            type: 'success'\n        });\n\n        // Remove the success message from localStorage to avoid showing it again.\n        localStorage.removeItem('successMessage');\n    }\n}\n\n/**\n * Get the scroll position of the page.\n *\n * @param {HTMLElement} page\n * @return {*|number}\n */\nfunction getPagePosition(page) {\n    if (page instanceof Window) {\n        // Get the scroll position of the page.\n        return page.scrollY;\n    } else {\n        // Get the scroll position of the page.\n        return page.scrollTop;\n    }\n}\n"],"names":["updatePageIntervalId","globalCourseid","pushMarks","assessmentmappingid","result","success","updateAssessments","message","currentrow","document","getElementById","closest","nextElementSibling","classList","contains","remove","errormessagerow","createElement","setAttribute","innerHTML","insertAdjacentElement","showTransferErrorMessage","error","window","console","courseid","update","assessments","JSON","parse","length","forEach","assessment","marksColumnFieldId","marksColumnField","marksContainer","querySelector","taskContainer","markscount","transferButton","style","display","task","progress","updateMarksColumn","clearInterval","page","successMessage","localStorage","getItem","addNotification","type","removeItem","displayNotification","querySelectorAll","item","addEventListener","value","getAttribute","pagePosition","Window","scrollY","scrollTop","getPagePosition","selectedTable","offset","scrollPosition","getBoundingClientRect","top","scrollTo","behavior","setInterval","visibilityState","initAssessmentUpdate","confirmTransferButton","async","assessmentmappings","Array","from","filter","element","parseInt","total","count","promises","promise","then","catch","push","Promise","all","notification","pushAllMarks","initConfirmationModal"],"mappings":"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"}
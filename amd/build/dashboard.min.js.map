{"version":3,"file":"dashboard.min.js","sources":["../src/dashboard.js"],"sourcesContent":["import {schedulePushTask, getAssessmentsUpdate, updateProgressBar} from \"./sitsgradepush_helper\";\nimport notification from \"core/notification\";\n\nlet updatePageIntervalId = null; // The interval ID for updating the progress.\nlet globalCourseid = null; // The global variable for course ID.\nlet updatePageDelay = 15000; // The delay for updating the page.\n\n/**\n * Initialize the dashboard page.\n *\n * @param {int} courseid\n */\nexport const init = (courseid) => {\n    // If there is a saved message by successfully mapped an assessment in localStorage, display it.\n    displayNotification();\n\n    // Set the global variable course ID.\n    globalCourseid = courseid;\n\n    // Initialize the module delivery dropdown list.\n    initModuleDeliverySelector(window);\n\n    // Initialize assessment updates.\n    initAssessmentUpdate(courseid);\n\n    // Initialize confirmation modal.\n    initConfirmationModal(window);\n};\n\n/**\n * Initialize the module delivery dropdown list.\n *\n * @param {Window} page\n */\nfunction initModuleDeliverySelector(page) {\n    // Find all the dropdown items.\n    let dropdownitems = document.querySelectorAll('.jump-to-dropdown-item');\n\n    // Add event listener to each dropdown item.\n    dropdownitems.forEach(function(item) {\n        item.addEventListener('click', function() {\n            let value = item.getAttribute('data-value');\n            if (value !== null) {\n                // Get the scroll position of the page.\n                let pagePosition = getPagePosition(page);\n\n                // Find the selected table by ID.\n                let selectedTable = document.getElementById(value);\n\n                // Calculate the scroll position to be 100 pixels above the table.\n                if (selectedTable) {\n                    let offset = -100;\n                    let tablePosition = selectedTable.getBoundingClientRect().top;\n                    let scrollPosition = pagePosition + tablePosition + offset;\n\n                    // Scroll to the calculated position.\n                    page.scrollTo({\n                        top: scrollPosition,\n                        behavior: \"smooth\"\n                    });\n                }\n            }\n        });\n    });\n}\n\n/**\n * Initialize the confirmation modal.\n *\n * @param {Window} page\n */\nfunction initConfirmationModal(page) {\n    // Find the confirmation modal.\n    let confirmTransferButton = document.getElementById(\"js-transfer-modal-button\");\n\n    // Exit if the confirmation modal is not found.\n    if (confirmTransferButton === null) {\n        return;\n    }\n\n    // Add event listener to the confirmation modal.\n    confirmTransferButton.addEventListener(\"click\", async function() {\n        let assessmentmappingid = confirmTransferButton.getAttribute('data-assessmentmappingid');\n        if (assessmentmappingid !== null && assessmentmappingid !== 'all') {\n            // Single transfer.\n            await pushMarks(assessmentmappingid);\n        } else if (assessmentmappingid === 'all') {\n            // Bulk transfer.\n            await pushAllMarks(page);\n        }\n    });\n}\n\n/**\n * Initialize the assessment updates.\n *\n * @param {int} courseid\n */\nfunction initAssessmentUpdate(courseid) {\n    updateAssessments(courseid);\n\n    // Update the page every 15 seconds.\n    updatePageIntervalId = setInterval(() => {\n        updateAssessments(courseid);\n    }, updatePageDelay);\n\n    // Add event listener to stop update the page when the page is not visible. e.g. when the user switches to another tab.\n    document.addEventListener(\"visibilitychange\", function() {\n        if (document.visibilityState === \"hidden\") {\n            clearInterval(updatePageIntervalId);\n        } else {\n            updateAssessments(courseid);\n            updatePageIntervalId = setInterval(() => {\n                updateAssessments(courseid);\n            }, updatePageDelay);\n        }\n    });\n}\n\n/**\n * Schedule a push task when the user clicks on a push button.\n *\n * @param {int} assessmentmappingid The button element.\n * @return {Promise|boolean} Promise.\n */\nasync function pushMarks(assessmentmappingid) {\n    try {\n        // Schedule a push task.\n        let result = await schedulePushTask(assessmentmappingid);\n\n        // Check if the push task is successfully scheduled.\n        if (result.success) {\n            // Update the UI once a task is scheduled successfully.\n            updateUIOnTaskScheduling(assessmentmappingid);\n        }\n        let message = '';\n        if (!result.success && result.message) {\n            message = result.message;\n        }\n\n        // Show error message if there is any.\n        showTransferErrorMessage(assessmentmappingid, message);\n        return result;\n    } catch (error) {\n        window.console.error(error);\n        return false;\n    }\n}\n\n/**\n *\n * @param {HTMLElement} page\n * @return {Promise<void>}\n */\nasync function pushAllMarks(page) {\n    let assessmentmappings = Array.from(document.querySelectorAll('.marks-col-field'))\n        .filter(element =>\n            parseInt(element.getAttribute('data-markscount'), 10) > 0 &&\n            element.getAttribute('data-task-running') === 'false'\n        );\n\n    // Number of not disabled push buttons.\n    let total = assessmentmappings.length;\n    let count = 0;\n\n    // Create an array to hold all the Promises.\n    let promises = [];\n\n    // Push grades to SITS for each component grade.\n    assessmentmappings.forEach(function(element) {\n        // Get the assessment mapping ID.\n        let assessmentmappingid = element.getAttribute('data-assessmentmappingid');\n        // Create a Promise for each button and push it into the array.\n        let promise = pushMarks(assessmentmappingid)\n            .then(function(result) {\n                if (result.success) {\n                    count = count + 1;\n                }\n                return result;\n            }).catch(function(error) {\n                window.console.error(error);\n            });\n\n        promises.push(promise);\n    });\n\n    // Wait for all Promises to resolve.\n    await Promise.all(promises);\n\n    // Scroll to the top of the page so that the user can see the notification.\n    page.scrollTo({top: 0, behavior: \"instant\"});\n\n    // Show the notification.\n    await notification.addNotification({\n        message: count + ' of ' + total + ' push tasks have been scheduled.',\n        type: (count === total) ? 'success' : 'warning'\n    });\n\n    // Update the page information.\n    updateAssessments(globalCourseid);\n}\n\n/**\n * Update the UI once a task is scheduled successfully.\n * e.g. hide change source button, show progress bar.\n *\n * @param {int} assessmentmappingid\n */\nfunction updateUIOnTaskScheduling(assessmentmappingid) {\n    // Find the change source button.\n    let changeSourceButton = document.getElementById('change-source-button-' + assessmentmappingid);\n    if (changeSourceButton) {\n        // Hide the change source button.\n        changeSourceButton.style.display = 'none';\n    }\n\n    // Hide the transfer button and show the progress bar immediately.\n    let assessments = [\n        {task: {progress: 0}, assessmentmappingid: assessmentmappingid, markscount: 0},\n    ];\n    updateMarksColumn(assessments);\n}\n\n/**\n * Update the dashboard page with the latest information.\n * e.g. progress bars, push buttons, records icons.\n *\n * @param {int} courseid\n * @return {Promise<void>}\n */\nasync function updateAssessments(courseid) {\n    // Get latest assessments information for the dashboard page.\n    let update = await getAssessmentsUpdate(courseid);\n\n    if (update.success) {\n        // Parse the JSON string.\n        let assessments = JSON.parse(update.assessments);\n\n        if (assessments.length > 0) {\n            updateMarksColumn(assessments);\n        }\n    } else {\n        // Stop update the page if error occurred.\n        clearInterval(updatePageIntervalId);\n        window.console.error(update.message);\n    }\n}\n\n/**\n * Update the marks' column for all assessments mappings.\n *\n * @param {object[]} assessments\n */\nfunction updateMarksColumn(assessments) {\n    // Update assessment components which has mappings.\n    assessments.forEach(assessment => {\n        let marksColumnFieldId = 'marks-col-field-' + assessment.assessmentmappingid;\n        let marksColumnField = document.getElementById(marksColumnFieldId);\n        if (marksColumnField) {\n            let marksContainer = marksColumnField.querySelector('.marks-container');\n            let taskContainer = marksColumnField.querySelector('.task-status-container');\n\n            // Set the marks count attribute.\n            marksColumnField.setAttribute('data-markscount', assessment.markscount);\n\n            // Marks count element that displays the number of marks.\n            let marksCountElement = marksColumnField.querySelector('.marks-count');\n\n            // Update the marks count.\n            marksCountElement.innerHTML = assessment.markscount;\n\n            // Show the transfer button if there are marks to transfer.\n            let transferButton = marksColumnField.querySelector('.js-btn-transfer-marks');\n            if (assessment.markscount > 0) {\n                transferButton.style.display = 'block';\n            } else {\n                transferButton.style.display = 'none';\n            }\n\n            // Show marks information if no task running.\n            if (assessment.task === null) {\n                marksColumnField.setAttribute('data-task-running', false);\n                taskContainer.style.display = 'none';\n                marksContainer.style.display = 'block';\n            } else {\n                // Show task information if task running.\n                marksColumnField.setAttribute('data-task-running', true);\n                marksContainer.style.display = 'none';\n                taskContainer.style.display = 'block';\n                updateProgressBar(taskContainer, assessment.task.progress);\n            }\n        }\n    });\n}\n\n/**\n * Show an error message at the table row under the button.\n *\n * @param {int} assessmentmappingid\n * @param {string} message\n */\nfunction showTransferErrorMessage(assessmentmappingid, message) {\n    // Find the marks column field.\n    let marksColumnField = document.getElementById('marks-col-field-' + assessmentmappingid);\n\n    // Find the closest row to the button.\n    let currentrow = marksColumnField.closest(\"tr\");\n\n    // Remove the existing error message row if it exists.\n    if (currentrow.nextElementSibling !== null &&\n        currentrow.nextElementSibling.classList.contains(\"error-message-row\")) {\n        currentrow.nextElementSibling.remove();\n    }\n\n    if (message !== '') {\n        // Create an error message row.\n        let errormessagerow = document.createElement(\"tr\");\n\n        // Set the class and content of the error message row.\n        errormessagerow.setAttribute(\"class\", \"error-message-row\");\n        errormessagerow.innerHTML =\n            '<td colspan=\"4>\">' +\n            '<div class=\"alert alert-danger\" role=\"alert\">' + message + '</div>' +\n            '</td>';\n\n        // Insert the error message row after the current row.\n        currentrow.insertAdjacentElement(\"afterend\", errormessagerow);\n    }\n}\n\n/**\n * Display a notification if a success message is available in localStorage.\n */\nfunction displayNotification() {\n    // Retrieve the success message from localStorage.\n    let successMessage = localStorage.getItem('successMessage');\n\n    // Check if a success message is available.\n    if (successMessage) {\n        // Display the success message using a notification library or other means.\n        notification.addNotification({\n            message: successMessage,\n            type: 'success'\n        });\n\n        // Remove the success message from localStorage to avoid showing it again.\n        localStorage.removeItem('successMessage');\n    }\n}\n\n/**\n * Get the scroll position of the page.\n *\n * @param {HTMLElement} page\n * @return {*|number}\n */\nfunction getPagePosition(page) {\n    if (page instanceof Window) {\n        // Get the scroll position of the page.\n        return page.scrollY;\n    } else {\n        // Get the scroll position of the page.\n        return page.scrollTop;\n    }\n}\n"],"names":["updatePageIntervalId","globalCourseid","pushMarks","assessmentmappingid","result","success","changeSourceButton","document","getElementById","style","display","updateMarksColumn","task","progress","markscount","updateUIOnTaskScheduling","message","currentrow","closest","nextElementSibling","classList","contains","remove","errormessagerow","createElement","setAttribute","innerHTML","insertAdjacentElement","showTransferErrorMessage","error","window","console","updateAssessments","courseid","update","assessments","JSON","parse","length","clearInterval","forEach","assessment","marksColumnFieldId","marksColumnField","marksContainer","querySelector","taskContainer","transferButton","page","successMessage","localStorage","getItem","addNotification","type","removeItem","displayNotification","querySelectorAll","item","addEventListener","value","getAttribute","pagePosition","Window","scrollY","scrollTop","getPagePosition","selectedTable","offset","scrollPosition","getBoundingClientRect","top","scrollTo","behavior","setInterval","visibilityState","initAssessmentUpdate","confirmTransferButton","async","assessmentmappings","Array","from","filter","element","parseInt","total","count","promises","promise","then","catch","push","Promise","all","notification","pushAllMarks","initConfirmationModal"],"mappings":"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"}